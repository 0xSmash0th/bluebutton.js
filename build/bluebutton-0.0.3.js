/**
 * BlueButton.js
 */

// v.0.0.3


(function () {
var Core=function(){var e=function(d,b,a,c){d=d.getElementsByTagName(b);for(b=0;b<d.length;b++)if(d[b].getAttribute(a)===c)return d[b]};return{parseXML:function(d){if(!d||"string"!==typeof d)return console.log("Error: XML data is not a string"),null;var b;window.DOMParser?(parser=new DOMParser,b=parser.parseFromString(d,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(d));return b},tagAttrVal:e,template:function(d){return e(this,"templateId","root",d).parentElement},
tag:function(d){return this.getElementsByTagName(d)[0]},elsByTag:function(d){return this.getElementsByTagName(d)},attr:function(d){return this.getAttribute(d)},val:function(){return this.childNodes[0].nodeValue},parseDate:function(d){var b=d.substr(0,4),a=d.substr(4,2);d=d.substr(6,2);return new Date(b,a,d)}}}();var Allergies=function(){return{process:function(e){var d=[],b,a;b=e.template("2.16.840.1.113883.10.20.22.2.6.1");e=b.elsByTag("entry");for(var c=0;c<e.length;c++){a=e[c];b=a.template("2.16.840.1.113883.10.20.22.4.7").tag("code");var f=b.attr("displayName"),h=b.attr("code"),g=b.attr("codeSystem"),j=b.attr("codeSystemName");b=a.template("2.16.840.1.113883.10.20.22.4.7").tag("value");var k=b.attr("displayName"),l=b.attr("code");b.attr("codeSystem");var m=b.attr("codeSystemName");b=a.template("2.16.840.1.113883.10.20.22.4.9").tag("value");
var n=b.attr("displayName"),q=b.attr("code"),p=b.attr("codeSystem");b=a.template("2.16.840.1.113883.10.20.22.4.8").tag("value");var r=b.attr("displayName");b=a.tag("participant").tag("code");var s=b.attr("displayName"),t=b.attr("code"),u=b.attr("codeSystem"),v=b.attr("codeSystemName");b=a.template("2.16.840.1.113883.10.20.22.4.28").tag("value");b=b.attr("displayName");d.push({date:{value:null,low:null,high:null},observation_date:{low:null},name:f,code:h,code_system:g,code_system_name:j,status:b,severity:r,
reaction:{date:{low:null},name:n,code:q,code_system:p},reaction_type:{name:k,code:l,code_system:p,code_system_name:m},allergen:{name:s,code:t,code_system:u,code_system_name:v}})}return d}}}();var Demographics=function(){var e=Core.parseDate;return{process:function(d){var b,a;b=d.template("2.16.840.1.113883.10.20.22.1.1");a=b.tag("patientRole");b=a.tag("patient").tag("name");d=b.tag("prefix").val();var c=b.tag("given").val(),f=b.tag("family").val();b=a.tag("patient");var h=e(b.tag("birthTime").attr("value")),g=b.tag("administrativeGenderCode").attr("displayName"),j=b.tag("maritalStatusCode").attr("displayName");b=a.tag("addr");var k=b.tag("streetAddressLine").val(),l=b.tag("city").val(),
m=b.tag("state").val(),n=b.tag("postalCode").val(),q=b.tag("country").val();b=a.tag("telecom");var p=b.attr("value");email=null;var r=a.tag("raceCode").attr("displayName"),s=a.tag("ethnicGroupCode").attr("displayName"),t=a.tag("religiousAffiliationCode").attr("displayName");b=a.tag("birthplace");var u=b.tag("state").val(),v=b.tag("postalCode").val(),w=b.tag("country").val();b=a.tag("guardian");var x=b.tag("code").attr("displayName"),y=b.tag("telecom").attr("value");b=b.tag("guardianPerson");var z=
b.tag("given").val(),A=b.tag("family").val();b=a.tag("guardian").tag("addr");var B=b.tag("streetAddressLine").val(),C=b.tag("city").val(),D=b.tag("state").val(),E=b.tag("postalCode").val(),F=b.tag("country").val();b=a.tag("providerOrganization");a=b.tag("name").val();var G=b.tag("telecom").attr("value"),H=b.tag("streetAddressLine").val(),I=b.tag("city").val(),J=b.tag("state").val(),K=b.tag("postalCode").val();b=b.tag("country").val();return{name:{prefix:d,given:c,family:f},dob:h,gender:g,marital_status:j,
address:{street:k,city:l,state:m,zip:n,country:q},phone:{home:p,work:null,mobile:null},email:email,race:r,ethnicity:s,religion:t,birthplace:{state:u,zip:v,country:w},guardian:{name:{given:z,family:A},relationship:x,address:{street:B,city:C,state:D,zip:E,country:F},phone:{home:y}},provider:{organization:a,phone:G,address:{street:H,city:I,state:J,zip:K,country:b}}}}}}();var Encounters=function(){var e=Core.parseDate;return{process:function(d){var b=[],a,c;a=d.template("2.16.840.1.113883.10.20.22.2.22.1");d=a.elsByTag("entry");for(var f=0;f<d.length;f++){c=d[f];var h=e(c.tag("effectiveTime").attr("value"));a=c.tag("code");var g=a.attr("displayName"),j=a.attr("code"),k=a.attr("codeSystem"),l=a.attr("codeSystemName"),m=a.attr("codeSystemVersion");a=c.tag("value");var n=a.attr("displayName"),q=a.attr("code"),p=a.attr("codeSystem");a=c.tag("translation");var r=a.attr("displayName"),
s=a.attr("code"),t=a.attr("codeSystem"),u=a.attr("codeSystemName");a=c.tag("performer").tag("code");var v=a.attr("displayName"),w=a.attr("code"),x=a.attr("codeSystem"),y=a.attr("codeSystemName");a=c.tag("participant");c=a.tag("code").attr("displayName");var z=a.tag("streetAddressLine").val(),A=a.tag("city").val(),B=a.tag("state").val(),C=a.tag("postalCode").val();a=a.tag("country").val();b.push({date:h,name:g,code:j,code_system:k,code_system_name:l,code_system_version:m,finding:{name:n,code:q,code_system:p},
translation:{name:r,code:s,code_system:t,code_system_name:u},performer:{name:v,code:w,code_system:x,code_system_name:y},location:{organization:c,street:z,city:A,state:B,zip:C,country:a}})}return b}}}();var Immunizations=function(){var e=Core.parseDate;return{process:function(d){var b=[],a,c;a=d.template("2.16.840.1.113883.10.20.22.2.2");d=a.elsByTag("entry");for(var f=0;f<d.length;f++){c=d[f];a=c.tag("effectiveTime");var h=e(a.attr("value"));a=c.template("2.16.840.1.113883.10.20.22.4.54").tag("code");var g=a.attr("displayName"),j=a.attr("code"),k=a.attr("codeSystem"),l=a.attr("codeSystemName");a=c.template("2.16.840.1.113883.10.20.22.4.54").tag("translation");var m=a.attr("displayName"),n=a.attr("code"),
q=a.attr("codeSystem"),p=a.attr("codeSystemName");a=c.tag("routeCode");var r=a.attr("displayName"),s=a.attr("code"),t=a.attr("codeSystem"),u=a.attr("codeSystemName");a=c.template("2.16.840.1.113883.10.20.22.4.20");c=a.tag("text").val();a=a.tag("code");var v=a.attr("displayName"),w=a.attr("code");a=a.attr("codeSystem");b.push({date:h,product:{name:g,code:j,code_system:k,code_system_name:l,translation:{name:m,code:n,code_system:q,code_system_name:p}},route:{name:r,code:s,code_system:t,code_system_name:u},
instructions:c,education_type:{name:v,code:w,code_system:a}})}return b}}}();var Labs=function(){var e=Core.parseDate;return{process:function(d){var b=[],a=[],c,f,h;c=d.template("2.16.840.1.113883.10.20.22.2.3.1");d=c.elsByTag("entry");for(var g=0;g<d.length;g++){f=d[g];c=f.tag("code");var j=c.attr("displayName"),k=c.attr("code"),l=c.attr("codeSystem"),m=c.attr("codeSystemName");f=f.elsByTag("component");for(g=0;g<f.length;g++){h=f[g];var n=e(h.tag("effectiveTime").attr("value"));c=h.tag("code");j=c.attr("displayName");k=c.attr("code");l=c.attr("codeSystem");m=c.attr("codeSystemName");
c=h.tag("value");h=c.attr("value");c=c.attr("unit");reference_high=reference_low=null;a.push({date:n,name:j,value:h,unit:c,code:k,code_system:l,code_system_name:m,reference:{low:reference_low,high:reference_high}})}b.push({name:j,code:k,code_system:l,code_system_name:m,results:a})}return b}}}();var Medications=function(){var e=Core.parseDate;return{process:function(d){var b=[],a,c;a=d.template("2.16.840.1.113883.10.20.22.2.1.1");d=a.elsByTag("entry");for(var f=0;f<d.length;f++){c=d[f];a=c.tag("effectiveTime");var h=e(a.tag("low").attr("value")),g=e(a.tag("high").attr("value"));a=c.tag("manufacturedProduct").tag("code");var j=a.attr("displayName"),k=a.attr("code"),l=a.attr("codeSystem");a=c.tag("manufacturedProduct").tag("translation");var m=a.attr("displayName"),n=a.attr("code"),q=a.attr("codeSystem"),
p=a.attr("codeSystemName"),r=c.tag("doseQuantity").attr("value");a=c.tag("rateQuantity");var s=a.attr("value"),t=a.attr("unit");a=c.tag("precondition").tag("value");var u=a.attr("displayName"),v=a.attr("code"),w=a.attr("codeSystem");a=c.template("2.16.840.1.113883.10.20.22.4.19").tag("value");var x=a.attr("displayName"),y=a.attr("code"),z=a.attr("codeSystem");a=c.tag("routeCode");var A=a.attr("displayName"),B=a.attr("code"),C=a.attr("codeSystem"),D=a.attr("codeSystemName");a=c.tag("participant").tag("code");
var E=a.attr("displayName"),F=a.attr("code"),G=a.attr("codeSystem"),H=a.attr("codeSystemName");a=c.tag("administrationUnitCode");var I=a.attr("displayName"),J=a.attr("code"),K=a.attr("codeSystem"),L=a.attr("codeSystemName");a=c.tag("performer");a=a.tag("name").val();b.push({effective_time:{low:h,high:g},product:{name:j,code:k,code_system:l,translation:{name:m,code:n,code_system:q,code_system_name:p}},dose_quantity:r,rate_quantity:{value:s,unit:t},precondition:{name:u,code:v,code_system:w},reason:{name:x,
code:y,code_system:z},route:{name:A,code:B,code_system:C,code_system_name:D},vehicle:{name:E,code:F,code_system:G,code_system_name:H},administration:{name:I,code:J,code_system:K,code_system_name:L},prescriber:{organization:a,person:null}})}return b}}}();var Problems=function(){var e=Core.parseDate;return{process:function(d){var b=[],a,c;a=d.template("2.16.840.1.113883.10.20.22.2.5");d=a.elsByTag("entry");for(var f=0;f<d.length;f++){c=d[f];a=c.tag("effectiveTime");var h=e(a.tag("low").attr("value")),g=e(a.tag("high").attr("value"));a=c.template("2.16.840.1.113883.10.20.22.4.4").tag("code");var j=a.attr("displayName"),k=a.attr("code"),l=a.attr("codeSystem");a=c.template("2.16.840.1.113883.10.20.22.4.6");var m=a.tag("value").attr("displayName");a=c.template("2.16.840.1.113883.10.20.22.4.31");
a=parseInt(a.tag("value").attr("value"));b.push({date:{from:h,to:g},name:j,status:m,age:a,code:k,code_system:l})}return b}}}();var Procedures=function(){var e=Core.parseDate;return{process:function(d){var b=[],a,c;a=d.template("2.16.840.1.113883.10.20.22.2.7");d=a.elsByTag("entry");for(var f=0;f<d.length;f++){c=d[f];a=c.tag("effectiveTime");var h=e(a.attr("value"));a=c.tag("code");var g=a.attr("displayName"),j=a.attr("code"),k=a.attr("codeSystem");specimen_code_system=specimen_code=specimen_name=null;a=c.tag("performer");var l=a.tag("name").val(),m=a.tag("telecom").attr("value"),n=a.tag("streetAddressLine").val(),q=a.tag("city").val(),
p=a.tag("state").val(),r=a.tag("postalCode").val(),s=a.tag("country").val();a=c.tag("participant").tag("code");c=a.attr("displayName");var t=a.attr("code");a=a.attr("codeSystem");b.push({date:h,name:g,code:j,code_system:k,specimen:{name:specimen_name,code:specimen_code,code_system:specimen_code_system},performer:{organization:l,street:n,city:q,state:p,zip:r,country:s,phone:m},device:{name:c,code:t,code_system:a}})}return b}}}();var Vitals=function(){var e=Core.parseDate;return{process:function(d){var b=[],a=[],c,f,h;c=d.template("2.16.840.1.113883.10.20.22.2.4.1");d=c.elsByTag("entry");for(var g=0;g<d.length;g++){f=d[g];c=f.tag("effectiveTime");var j=e(c.attr("value"));f=f.elsByTag("component");for(g=0;g<f.length;g++){h=f[g];c=h.tag("code");var k=c.attr("displayName"),l=c.attr("code"),m=c.attr("codeSystem"),n=c.attr("codeSystemName");c=h.tag("value");h=c.attr("value");c=c.attr("unit");a.push({name:k,code:l,code_system:m,
code_system_name:n,value:h,unit:c})}b.push({date:j,results:a})}return b}}}();var BlueButton=function(e){var d=null,b={};e=e.replace(/^\s+|\s+$/g,"");if("<?xml"==e.substr(0,5)){d=Core.parseXML(xml);e=d.getElementsByTagName("*");for(var a=0;a<e.length;a++)e[a].template=Core.template,e[a].tag=Core.tag,e[a].elsByTag=Core.elsByTag,e[a].attr=Core.attr,e[a].val=Core.val;d.template=Core.template;b.allergies=Allergies.process(d);b.demographics=Demographics.process(d);b.encounters=Encounters.process(d);b.immunizations=Immunizations.process(d);b.labs=Labs.process(d);b.medications=Medications.process(d);
b.problems=Problems.process(d);b.procedures=Procedures.process(d);b.vitals=Vitals.process(d);e=[b,b.allergies,b.demographics,b.encounters,b.immunizations,b.labs,b.medications,b.problems,b.procedures,b.vitals];for(a=0;a<e.length;a++)e[a].json=function(){return JSON.stringify(this,null,2)}}else b=JSON.parse(e);return{data:b,xmlDOM:d,allergies:function(){return b.allergies},demographics:function(){return b.demographics},encounters:function(){return b.encounters},immunizations:function(){return b.immunizations},
labs:function(){return b.labs},medications:function(){return b.medications},problems:function(){return b.problems},procedures:function(){return b.procedures},vitals:function(){return b.vitals}}};window.BlueButton=BlueButton;
})();
